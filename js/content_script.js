(()=>{"use strict";function n(n){var e,o,t;const r=document.createElement("button");let i=!1;const c={primary:Object.assign(Object.assign({},{backgroundColor:"#005acc",hoverBackgroundColor:"#1467d0",color:"white"}),null===(e=n.styles)||void 0===e?void 0:e.primary),loading:Object.assign(Object.assign({},{backgroundColor:"#cccccc",color:"#666666"}),null===(o=n.styles)||void 0===o?void 0:o.loading),common:Object.assign(Object.assign({},{padding:"6px 10px",fontSize:"12px",borderRadius:"6px",margin:"0 4px"}),null===(t=n.styles)||void 0===t?void 0:t.common)},a=e=>{if(i=e,e){r.disabled=!0,r.style.cssText=`\n        background-color: ${c.loading.backgroundColor};\n        color: ${c.loading.color};\n        border: none;\n        padding: ${c.common.padding};\n        font-size: ${c.common.fontSize};\n        font-weight: bold;\n        border-radius: ${c.common.borderRadius};\n        cursor: not-allowed;\n        margin: ${c.common.margin};\n        display: block;\n        transition: all 0.3s ease;\n        position: relative;\n        overflow: hidden;\n      `,(()=>{if(!document.querySelector("#spinner-animation")){const n=document.createElement("style");n.id="spinner-animation",n.textContent="\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      ",document.head.appendChild(n)}})();const e=document.createElement("span");e.style.cssText="\n        display: inline-block;\n        margin-right: 8px;\n        animation: spin 1s linear infinite;\n      ",r.textContent="",r.appendChild(e),r.appendChild(document.createTextNode(n.loadingText))}else r.textContent=n.text,r.disabled=!1,r.style.cssText=`\n        background-color: ${c.primary.backgroundColor};\n        color: ${c.primary.color};\n        border: none;\n        padding: ${c.common.padding};\n        font-size: ${c.common.fontSize};\n        font-weight: bold;\n        border-radius: ${c.common.borderRadius};\n        cursor: pointer;\n        margin: ${c.common.margin};\n        display: block;\n        transition: all 0.3s ease;\n      `};return a(!1),r.addEventListener("mouseenter",()=>{i||(r.style.backgroundColor=c.primary.hoverBackgroundColor)}),r.addEventListener("mouseleave",()=>{i||(r.style.backgroundColor=c.primary.backgroundColor)}),r.addEventListener("click",()=>{return e=this,o=void 0,r=function*(){if(!i)try{a(!0),yield n.onClick()}catch(n){console.error("按钮点击处理出错:",n);if(n.message&&n.message.includes("Extension context invalidated")){console.warn("Extension context invalidated, skipping action");return}throw n}finally{a(!1)}},new((t=void 0)||(t=Promise))(function(n,i){function c(n){try{s(r.next(n))}catch(n){i(n)}}function a(n){try{s(r.throw(n))}catch(n){i(n)}}function s(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t(function(n){n(o)})).then(c,a)}s((r=r.apply(e,o||[])).next())});var e,o,t,r}),r}var e=function(n,e,o,t){return new(o||(o=Promise))(function(r,i){function c(n){try{s(t.next(n))}catch(n){i(n)}}function a(n){try{s(t.throw(n))}catch(n){i(n)}}function s(n){var e;n.done?r(n.value):(e=n.value,e instanceof o?e:new o(function(n){n(e)})).then(c,a)}s((t=t.apply(n,e||[])).next())})};let o=!0;function s(n,e,o=3,t=1e3){return new Promise((r,i)=>{if(!chrome.runtime||!chrome.runtime.sendMessage)return void i(new Error("Extension context invalidated"));let c=0;const a=()=>{chrome.runtime.sendMessage(n,n=>{if(chrome.runtime.lastError){if(chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Extension context invalidated")||chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Could not establish connection"))return c<o?(c++,void setTimeout(a,t*c)):void i(new Error("Extension context invalidated"));i(chrome.runtime.lastError)}else e&&e(n),r(n)})};a()})}function t(){var n;const e=document.querySelector(".cover-title");return null===(n=null==e?void 0:e.textContent)||void 0===n?void 0:n.trim()}function r(n){return e(this,void 0,void 0,function*(){return`${yield function(){return e(this,void 0,void 0,function*(){return new Promise(n=>{chrome.storage.sync.get(["fileNamePrefix"],e=>{n(e.fileNamePrefix||"storybook_")})})})}()}${n.replace(/\s+/g,"_").slice(0,36)}`})}function i(){const n=Array.from(document.querySelectorAll("storybook-image-page-content .storybook-image.ng-star-inserted img")).map(n=>n.getAttribute("src")),e=Array.from(document.querySelectorAll("storybook-text-page-content .story-and-actions-container .story-text")).map(n=>{var e;return null===(e=n.textContent)||void 0===e?void 0:e.trim()});return{images:Array.from(new Set(n)),contents:Array.from(new Set(e))}}function c(){if(o&&function(){const n=document.querySelector("storybook-image-page-content"),e=document.querySelector("storybook-text-page-content");return!(!n&&!e)}()){const o=function(){var n;let e=document.querySelector(".action-buttons");if(!e){const o=document.querySelector("storybook-image-page-content, storybook-text-page-content");o&&(e=o.querySelector(".action-buttons")||(null===(n=o.parentElement)||void 0===n?void 0:n.querySelector(".action-buttons"))||null)}return e}();o&&function(o){if(o.querySelector(".gemini-video-generator-button"))return;const c=function(){return n({text:chrome.i18n.getMessage("downloadImagesAndTexts"),loadingText:chrome.i18n.getMessage("downloadImagesAndTextsLoading"),onClick:()=>e(this,void 0,void 0,function*(){const n=t(),{images:e,contents:o}=i(),c=yield r(n||"images_texts");return s({action:"downloadZip",urls:e,text:[n,...o].join("\n\n"),zipName:c})})})}();c.classList.add("gemini-video-generator-button"),o.insertBefore(c,o.firstChild);const a=function(){return n({text:chrome.i18n.getMessage("downloadPDF"),loadingText:chrome.i18n.getMessage("downloadPDFLoading"),onClick:()=>e(this,void 0,void 0,function*(){const n=t(),{images:e,contents:o}=i(),c=yield r(n||"pdf");return s({action:"downloadPDF",urls:e,title:n,contents:o,fileName:c+".pdf"})})})}();a.classList.add("gemini-video-generator-button"),o.insertBefore(a,o.firstChild)}(o)}else document.querySelectorAll(".gemini-video-generator-button").forEach(n=>n.remove())}function a(){return e(this,void 0,void 0,function*(){o=yield function(){return e(this,void 0,void 0,function*(){return new Promise(n=>{chrome.storage.sync.get(["showExportButton"],e=>{n(void 0===e.showExportButton||e.showExportButton)})})})}(),chrome.storage.onChanged.addListener((n,e)=>{"sync"===e&&n.showExportButton&&(o=n.showExportButton.newValue,c())}),c(),new MutationObserver(()=>{c()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a()})();